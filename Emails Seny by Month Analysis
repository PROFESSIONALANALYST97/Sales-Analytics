select
id_account,
month_of_sending,
CAST(sent_month AS FLOAT64) as sent_month,
CAST(sent_month AS FLOAT64)/sum(CAST(sent_month AS FLOAT64)) over (partition by month_of_sending) * 100 as sent_msg_percent_from_this_month,
first_sent_date,
last_sent_date
from
(select
a.id as id_account,
date_trunc(date_add(s.date, INTERVAL e.sent_date day) , month) as month_of_sending,
count(e.id_message) as sent_month,
max(date_add(s.date, INTERVAL e.sent_date day)) as last_sent_date,
min(date_add(s.date, INTERVAL e.sent_date day)) as first_sent_date
from `data-analytics-mate.DA.email_sent`e
join `data-analytics-mate.DA.account`a
on e.id_account = a.id
join `data-analytics-mate.DA.account_session`acs
on acs.account_id = a.id
join `data-analytics-mate.DA.session`s
on acs.ga_session_id = s.ga_session_id
group by id_account, month_of_sending)






SELECT
day_date,
date,
revenue,
SUM(revenue) OVER(ORDER BY date) as acc_revenue,
SUM(predict) OVER(PARTITION BY day_daORDER BY date) as acc_predict,
SUM(revenue) OVER(PARTITION BY day_date ORDER BY date)/SUM(predict) OVER(PARTITION BY day_date ORDER BY date) as ratio
FROM(
SELECT
date,
date (EXTRACT(year from date), EXTRACT (month from date), EXTRACT (day from date),1) as day_date,
SUM(revenue) as revenue,
SUM (predict) as predict
FROM (


SELECT
s.date as date,
SUM(p.price) as revenue,
0 as predict
FROM `data-analytics-mate.DA.order` as o
JOIN `data-analytics-mate.DA.product` as p
ON o.item_id = p.item_id
JOIN `data-analytics-mate.DA.session` as s
ON o.ga_session_id = s.ga_session_id
GROUP BY s.date


UNION ALL


SELECT
rp.date as date,
0 as revenue,
sum(predict) as predict
FROM `data-analytics-mate.DA.revenue_predict` as rp
GROUP BY rp.date


) union_data
GROUP BY date, date(EXTRACT(year from date), EXTRACT (month from date), EXTRACT (day from date), 1)) as union_data2


